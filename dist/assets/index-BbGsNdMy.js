(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();const V={confidenceThresholdName:.8,confidenceThresholdSeat:.9,scanTimeoutMs:1500,retryIntervalMs:300,audioPlaybackRate:1},de=e=>Number.isNaN(e)?0:Math.min(1,Math.max(0,e)),W=(e,t)=>t,q={confidenceThresholdName:de(W(void 0,V.confidenceThresholdName)),confidenceThresholdSeat:de(W(void 0,V.confidenceThresholdSeat)),scanTimeoutMs:Math.max(0,W(void 0,V.scanTimeoutMs)),retryIntervalMs:Math.max(0,W(void 0,V.retryIntervalMs)),audioPlaybackRate:Math.max(.1,W(void 0,V.audioPlaybackRate))},xe={Ready:["Scanning","RetryNeeded"],Scanning:["Recognized","RetryNeeded","Ready"],Recognized:["Scanning","Ready"],RetryNeeded:["Scanning","Ready"]};class Ce{state;listeners;constructor(t="Ready"){this.state=t,this.listeners=new Set}getState(){return this.state}setState(t){const s=xe[this.state];if(t===this.state||s.includes(t)){this.state=t,this.notify();return}throw new Error(`Invalid scan state transition: ${this.state} -> ${t}`)}subscribe(t){return this.listeners.add(t),t(this.state),()=>{this.listeners.delete(t)}}notify(){for(const t of this.listeners)t(this.state)}}const Ae=360,we=2.5,ue=.06,ke=.1,Te=.34,Ee=.12,Ie=.72,Re=180,Le=250,Ne=.65,Oe=.35,oe=document.createElement("canvas"),ne=oe.getContext("2d",{willReadFrequently:!0}),Q=(e,t,s)=>Math.max(t,Math.min(s,e)),Ue=(e,t,s)=>{const n=e/255,o=t/255,a=s/255,c=Math.max(n,o,a),d=Math.min(n,o,a),u=c-d;let l=0;u!==0&&(c===n?l=(o-a)/u%6:c===o?l=(a-n)/u+2:l=(n-o)/u+4,l*=60,l<0&&(l+=360));const f=c===0?0:u/c;return{hue:l,saturation:f,value:c}},se=(e,t,s)=>{const n=new Uint8Array(e.length);for(let o=1;o<s-1;o+=1)for(let a=1;a<t-1;a+=1){let c=0;for(let d=-1;d<=1&&c===0;d+=1)for(let u=-1;u<=1;u+=1)if(e[(o+d)*t+(a+u)]===1){c=1;break}n[o*t+a]=c}return n},ge=(e,t,s)=>{const n=new Uint8Array(e.length);for(let o=1;o<s-1;o+=1)for(let a=1;a<t-1;a+=1){let c=1;for(let d=-1;d<=1&&c===1;d+=1)for(let u=-1;u<=1;u+=1)if(e[(o+d)*t+(a+u)]===0){c=0;break}n[o*t+a]=c}return n},_e=(e,t,s)=>se(ge(e,t,s),t,s),me=(e,t,s)=>ge(se(e,t,s),t,s),Fe=(e,t,s)=>{const n=new Float32Array(t*s);let o=0,a=0,c=0;for(let i=1;i<s-1;i+=1)for(let m=1;m<t-1;m+=1){const p=e[(i-1)*t+(m-1)],g=e[(i-1)*t+m],v=e[(i-1)*t+(m+1)],T=e[i*t+(m-1)],E=e[i*t+(m+1)],A=e[(i+1)*t+(m-1)],w=e[(i+1)*t+m],h=e[(i+1)*t+(m+1)],P=-p+v-T*2+E*2-A+h,R=-p-g*2-v+A+w*2+h,x=Math.abs(P)+Math.abs(R),D=i*t+m;n[D]=x,o+=x,a+=x*x,c+=1}if(c===0)return new Uint8Array(t*s);const d=o/c,u=Math.sqrt(Math.max(0,a/c-d*d)),l=d+u*Ne,f=new Uint8Array(t*s);for(let i=0;i<f.length;i+=1)f[i]=n[i]>=l?1:0;return f},$e=(e,t,s)=>{const n=t*s,o=new Float32Array(n),a=new Float32Array(n),c=new Float32Array(n),d=new Uint8Array(n);let u=0,l=0,f=0;for(let r=0;r<n;r+=1){const M=r*4,I=e[M],b=e[M+1],C=e[M+2],{hue:L,saturation:H,value:le}=Ue(I,b,C);o[r]=L,a[r]=H,c[r]=le,d[r]=Math.round(.299*I+.587*b+.114*C),u+=H,l+=H*H,f+=le}const i=u/n,m=Math.sqrt(Math.max(0,l/n-i*i)),p=f/n,g=Q(i+m*.3,ke,Te),v=Q(p-.25,.12,.45),T=new Uint8Array(n),E=new Uint8Array(n),A=new Uint8Array(n);for(let r=0;r<n;r+=1){const M=o[r],I=a[r],b=c[r],C=I<=Ee&&b>=Ie;A[r]=C?1:0;const L=I>=g&&b>=v;T[r]=L&&!C?1:0;const H=M>=Re&&M<=Le&&I>=.2&&b>=.15;E[r]=H?1:0}const w=Fe(d,t,s),h=new Uint8Array(n);for(let r=0;r<n;r+=1)h[r]=T[r]===1||E[r]===1?1:0;const P=se(h,t,s),R=new Uint8Array(n);for(let r=0;r<n;r+=1){const M=w[r]===1&&P[r]===1&&A[r]===0;R[r]=M?1:0}const x=new Uint8Array(n);for(let r=0;r<n;r+=1)x[r]=h[r]===1||R[r]===1?1:0;const D=me(_e(x,t,s),t,s),y=me(w,t,s);return{colorMask:h,edgeMask:w,fusedMask:D,edgeOnlyMask:y}},Pe=(e,t)=>{const s=e.maxX-e.minX+1,n=e.maxY-e.minY+1,o=s*n;if(o<=0||e.area<=0)return 0;const a=o/t,c=e.area/o,d=s>n?s/n:n/s,u=1-Math.min(1,Math.abs(d-we)/1.6),l=e.colorHits/e.area,f=e.edgeHits/e.area,i=a*1.3+c*.7+u*.9+l*.9+f*.5;return Q(i/4.3,0,1)},fe=(e,t,s,n,o,a)=>{const c=new Uint8Array(e.length),d=new Int32Array(e.length),u=new Int32Array(e.length),l=Math.round(n*o*a);let f=null;for(let i=0;i<o;i+=1)for(let m=0;m<n;m+=1){const p=i*n+m;if(e[p]===0||c[p]===1)continue;let g=0,v=0;d[v]=m,u[v]=i,v+=1,c[p]=1;let T=0,E=m,A=i,w=m,h=i,P=0,R=0;for(;g<v;){const y=d[g],r=u[g];g+=1;const M=r*n+y;T+=1,t[M]===1&&(P+=1),s[M]===1&&(R+=1),y<E&&(E=y),r<A&&(A=r),y>w&&(w=y),r>h&&(h=r);const I=[[y+1,r],[y-1,r],[y,r+1],[y,r-1]];for(const[b,C]of I){if(b<0||C<0||b>=n||C>=o)continue;const L=C*n+b;c[L]===1||e[L]===0||(c[L]=1,d[v]=b,u[v]=C,v+=1)}}if(T<l)continue;const x={minX:E,minY:A,maxX:w,maxY:h,area:T,colorHits:P,edgeHits:R},D=Pe(x,n*o);(!f||D>f.score)&&(f={component:x,score:D})}return f},De=e=>{if(!ne)return{found:!1,confidence:0,box:null};const t=e.videoWidth,s=e.videoHeight;if(t<=0||s<=0)return{found:!1,confidence:0,box:null};const n=Math.min(1,Ae/Math.max(t,s)),o=Math.max(1,Math.round(t*n)),a=Math.max(1,Math.round(s*n));oe.width=o,oe.height=a,ne.drawImage(e,0,0,o,a);const c=ne.getImageData(0,0,o,a),d=$e(c.data,o,a);let l=fe(d.fusedMask,d.colorMask,d.edgeMask,o,a,ue);if(!l||l.score<Oe){const g=fe(d.edgeOnlyMask,d.colorMask,d.edgeMask,o,a,ue);g&&(!l||g.score*.9>l.score)&&(l={component:g.component,score:g.score*.9})}if(!l)return{found:!1,confidence:0,box:null};const f=l.component.maxX-l.component.minX+1,i=l.component.maxY-l.component.minY+1,m=Q(l.score,0,1),p=1/n;return{found:!0,confidence:m,box:{x:Math.round(l.component.minX*p),y:Math.round(l.component.minY*p),width:Math.round(f*p),height:Math.round(i*p)}}},ve=document.querySelector("#app");if(!ve)throw new Error("Missing #app container");const _=/Chrome/.test(navigator.userAgent)&&!/Edg|OPR/.test(navigator.userAgent),F=!!navigator.mediaDevices?.getUserMedia,O=new Ce("Ready"),he=q.retryIntervalMs;let X="environment",$=null;const He={segments:[]};ve.innerHTML=`
  <main class="shell">
    <header>
      <h1>OCR Ticket Reader</h1>
      <p>MVP scaffold initialized for desktop Chrome.</p>
    </header>
    <section class="panel">
      <p><strong>Browser check:</strong> ${_?"Chrome detected":"Please use desktop Chrome for MVP."}</p>
      <p><strong>Camera API:</strong> ${F?"Available":"Not available"}</p>
      <p><strong>Name confidence threshold:</strong> ${q.confidenceThresholdName}</p>
      <p><strong>Seat confidence threshold:</strong> ${q.confidenceThresholdSeat}</p>
      <p><strong>Scan timeout (ms):</strong> ${q.scanTimeoutMs}</p>
      <p><strong>Retry interval (ms):</strong> ${q.retryIntervalMs}</p>
      <p><strong>Frame sample interval (ms):</strong> ${he}</p>
      <p><strong>Audio playback rate:</strong> ${q.audioPlaybackRate}</p>
      <p id="app-state"><strong>App state:</strong> ${O.getState()}</p>
      <p><strong>Latest OCR result:</strong> None</p>
      <p><strong>Queued audio segments:</strong> ${He.segments.length}</p>
      <p id="camera-message">Camera preview not started.</p>
      <p id="sample-status"><strong>Sample loop:</strong> idle</p>
      <div class="camera-controls">
        <label for="camera-select"><strong>Camera:</strong></label>
        <select id="camera-select" disabled>
          <option value="">Default rear camera</option>
        </select>
        <button id="switch-facing-btn" type="button" disabled>Switch to Front Camera</button>
      </div>
      <div class="preview-frame">
        <video id="camera-preview" autoplay muted playsinline></video>
        <div id="ticket-overlay" class="ticket-overlay hidden"></div>
      </div>
      <div class="actions">
        <button id="start-camera-btn" type="button">Enable Camera</button>
        <button id="stop-camera-btn" type="button" disabled>Stop Camera</button>
      </div>
    </section>
  </main>
`;const ye=document.querySelector("#app-state"),Me=document.querySelector("#camera-message"),be=document.querySelector("#sample-status"),U=document.querySelector("#camera-preview"),N=document.querySelector("#ticket-overlay"),S=document.querySelector("#camera-select"),z=document.querySelector("#switch-facing-btn"),Y=document.querySelector("#start-camera-btn"),J=document.querySelector("#stop-camera-btn");if(!ye||!Me||!be||!U||!N||!S||!z||!Y||!J)throw new Error("Missing camera preview elements");let k=null,j=null,K=0;const G=document.createElement("canvas"),pe=G.getContext("2d"),qe=e=>{const t=e.toLowerCase();return/(back|rear|environment|world)/.test(t)?"environment":/(front|user|facetime|selfie)/.test(t)?"user":null},Se=()=>{z.textContent=X==="environment"?"Switch to Front Camera":"Switch to Rear Camera"},Z=e=>{S.disabled=!e,z.disabled=!e,Se()},ee=async()=>{if(!navigator.mediaDevices?.enumerateDevices){S.innerHTML='<option value="">Default camera</option>';return}const t=(await navigator.mediaDevices.enumerateDevices()).filter(n=>n.kind==="videoinput");if(t.length===0){S.innerHTML='<option value="">No camera devices detected</option>';return}S.innerHTML="";const s=document.createElement("option");s.value="",s.textContent=X==="environment"?"Default rear camera":"Default front camera",S.append(s);for(const[n,o]of t.entries()){const a=document.createElement("option");a.value=o.deviceId,a.textContent=o.label||`Camera ${n+1}`,S.append(a)}$?S.value=$:S.value=""},Be=()=>$?{deviceId:{exact:$},width:{ideal:1280},height:{ideal:720}}:{facingMode:{ideal:X},width:{ideal:1280},height:{ideal:720}},Xe=e=>{ye.innerHTML=`<strong>App state:</strong> ${e}`},B=e=>{Me.textContent=e},ae=e=>{be.innerHTML=`<strong>Sample loop:</strong> ${e}`},re=()=>{N.classList.add("hidden")},Ye=(e,t,s)=>{if(!e.found||!e.box||t<=0||s<=0){re();return}const n=e.box.x/t*100,o=e.box.y/s*100,a=e.box.width/t*100,c=e.box.height/s*100;N.style.left=`${n}%`,N.style.top=`${o}%`,N.style.width=`${a}%`,N.style.height=`${c}%`,N.classList.remove("hidden")};O.subscribe(Xe);const ce=()=>{j!==null&&(window.clearInterval(j),j=null),K=0,ae("idle")},Ve=()=>{if(!pe||!k)return;const e=U.videoWidth,t=U.videoHeight;if(e<=0||t<=0)return;G.width!==e&&(G.width=e),G.height!==t&&(G.height=t),pe.drawImage(U,0,0,e,t);const s=De(U);Ye(s,e,t),K+=1,ae(s.found?`running (${K} samples, ticket confidence ${s.confidence.toFixed(2)})`:`running (${K} samples, searching ticket)`)},We=()=>{ce(),ae("starting"),j=window.setInterval(Ve,he)},te=()=>{if(ce(),re(),!!k){for(const e of k.getTracks())e.stop();k=null,U.srcObject=null,J.disabled=!0,Y.disabled=!F||!_,Z(F&&_),O.setState("Ready"),B("Camera preview stopped.")}},ie=async()=>{if(!F){O.setState("RetryNeeded"),B("Camera API is unavailable in this browser.");return}if(!_){O.setState("RetryNeeded"),B("MVP camera flow is currently supported on desktop Chrome only.");return}try{Y.disabled=!0,B("Requesting camera permission..."),k=await navigator.mediaDevices.getUserMedia({video:Be(),audio:!1}),U.srcObject=k;const e=k.getVideoTracks()[0],s=e?.getSettings()?.deviceId;if(s&&($=s),e?.label){const n=qe(e.label);n&&(X=n)}await ee(),O.setState("Scanning"),B("Camera preview active."),K=0,We(),J.disabled=!1,Z(!0)}catch(e){ce(),re(),O.setState("RetryNeeded"),Y.disabled=!1,Z(F&&_),B(e instanceof Error?`Unable to start camera: ${e.message}`:"Unable to start camera.")}};Y.disabled=!F||!_;Z(F&&_);ee();Y.addEventListener("click",()=>{ie()});J.addEventListener("click",te);S.addEventListener("change",()=>{$=S.value||null,k&&(te(),ie())});z.addEventListener("click",()=>{X=X==="environment"?"user":"environment",$=null,ee(),k?(te(),ie()):Se()});navigator.mediaDevices?.addEventListener?.("devicechange",()=>{ee()});window.addEventListener("beforeunload",te);
