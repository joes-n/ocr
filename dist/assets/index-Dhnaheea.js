(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();const H={confidenceThresholdName:.8,confidenceThresholdSeat:.9,scanTimeoutMs:1500,retryIntervalMs:300,audioPlaybackRate:1},ne=e=>Number.isNaN(e)?0:Math.min(1,Math.max(0,e)),B=(e,t)=>t,P={confidenceThresholdName:ne(B(void 0,H.confidenceThresholdName)),confidenceThresholdSeat:ne(B(void 0,H.confidenceThresholdSeat)),scanTimeoutMs:Math.max(0,B(void 0,H.scanTimeoutMs)),retryIntervalMs:Math.max(0,B(void 0,H.retryIntervalMs)),audioPlaybackRate:Math.max(.1,B(void 0,H.audioPlaybackRate))},pe={Ready:["Scanning","RetryNeeded"],Scanning:["Recognized","RetryNeeded","Ready"],Recognized:["Scanning","Ready"],RetryNeeded:["Scanning","Ready"]};class ge{state;listeners;constructor(t="Ready"){this.state=t,this.listeners=new Set}getState(){return this.state}setState(t){const s=pe[this.state];if(t===this.state||s.includes(t)){this.state=t,this.notify();return}throw new Error(`Invalid scan state transition: ${this.state} -> ${t}`)}subscribe(t){return this.listeners.add(t),t(this.state),()=>{this.listeners.delete(t)}}notify(){for(const t of this.listeners)t(this.state)}}const he=360,ye=2.5,oe=.06,Me=.1,ve=.34,be=.12,Se=.72,xe=180,Ae=250,Ce=.65,ke=.35,Q=document.createElement("canvas"),j=Q.getContext("2d",{willReadFrequently:!0}),V=(e,t,s)=>Math.max(t,Math.min(s,e)),Te=(e,t,s)=>{const n=e/255,o=t/255,r=s/255,c=Math.max(n,o,r),d=Math.min(n,o,r),u=c-d;let l=0;u!==0&&(c===n?l=(o-r)/u%6:c===o?l=(r-n)/u+2:l=(n-o)/u+4,l*=60,l<0&&(l+=360));const f=c===0?0:u/c;return{hue:l,saturation:f,value:c}},Z=(e,t,s)=>{const n=new Uint8Array(e.length);for(let o=1;o<s-1;o+=1)for(let r=1;r<t-1;r+=1){let c=0;for(let d=-1;d<=1&&c===0;d+=1)for(let u=-1;u<=1;u+=1)if(e[(o+d)*t+(r+u)]===1){c=1;break}n[o*t+r]=c}return n},ce=(e,t,s)=>{const n=new Uint8Array(e.length);for(let o=1;o<s-1;o+=1)for(let r=1;r<t-1;r+=1){let c=1;for(let d=-1;d<=1&&c===1;d+=1)for(let u=-1;u<=1;u+=1)if(e[(o+d)*t+(r+u)]===0){c=0;break}n[o*t+r]=c}return n},Re=(e,t,s)=>Z(ce(e,t,s),t,s),se=(e,t,s)=>ce(Z(e,t,s),t,s),Ee=(e,t,s)=>{const n=new Float32Array(t*s);let o=0,r=0,c=0;for(let i=1;i<s-1;i+=1)for(let m=1;m<t-1;m+=1){const p=e[(i-1)*t+(m-1)],g=e[(i-1)*t+m],h=e[(i-1)*t+(m+1)],k=e[i*t+(m-1)],T=e[i*t+(m+1)],A=e[(i+1)*t+(m-1)],C=e[(i+1)*t+m],y=e[(i+1)*t+(m+1)],L=-p+h-k*2+T*2-A+y,E=-p-g*2-h+A+C*2+y,S=Math.abs(L)+Math.abs(E),U=i*t+m;n[U]=S,o+=S,r+=S*S,c+=1}if(c===0)return new Uint8Array(t*s);const d=o/c,u=Math.sqrt(Math.max(0,r/c-d*d)),l=d+u*Ce,f=new Uint8Array(t*s);for(let i=0;i<f.length;i+=1)f[i]=n[i]>=l?1:0;return f},Ie=(e,t,s)=>{const n=t*s,o=new Float32Array(n),r=new Float32Array(n),c=new Float32Array(n),d=new Uint8Array(n);let u=0,l=0,f=0;for(let a=0;a<n;a+=1){const v=a*4,R=e[v],b=e[v+1],x=e[v+2],{hue:I,saturation:_,value:te}=Te(R,b,x);o[a]=I,r[a]=_,c[a]=te,d[a]=Math.round(.299*R+.587*b+.114*x),u+=_,l+=_*_,f+=te}const i=u/n,m=Math.sqrt(Math.max(0,l/n-i*i)),p=f/n,g=V(i+m*.3,Me,ve),h=V(p-.25,.12,.45),k=new Uint8Array(n),T=new Uint8Array(n),A=new Uint8Array(n);for(let a=0;a<n;a+=1){const v=o[a],R=r[a],b=c[a],x=R<=be&&b>=Se;A[a]=x?1:0;const I=R>=g&&b>=h;k[a]=I&&!x?1:0;const _=v>=xe&&v<=Ae&&R>=.2&&b>=.15;T[a]=_?1:0}const C=Ee(d,t,s),y=new Uint8Array(n);for(let a=0;a<n;a+=1)y[a]=k[a]===1||T[a]===1?1:0;const L=Z(y,t,s),E=new Uint8Array(n);for(let a=0;a<n;a+=1){const v=C[a]===1&&L[a]===1&&A[a]===0;E[a]=v?1:0}const S=new Uint8Array(n);for(let a=0;a<n;a+=1)S[a]=y[a]===1||E[a]===1?1:0;const U=se(Re(S,t,s),t,s),M=se(C,t,s);return{colorMask:y,edgeMask:C,fusedMask:U,edgeOnlyMask:M}},we=(e,t)=>{const s=e.maxX-e.minX+1,n=e.maxY-e.minY+1,o=s*n;if(o<=0||e.area<=0)return 0;const r=o/t,c=e.area/o,d=s>n?s/n:n/s,u=1-Math.min(1,Math.abs(d-ye)/1.6),l=e.colorHits/e.area,f=e.edgeHits/e.area,i=r*1.3+c*.7+u*.9+l*.9+f*.5;return V(i/4.3,0,1)},re=(e,t,s,n,o,r)=>{const c=new Uint8Array(e.length),d=new Int32Array(e.length),u=new Int32Array(e.length),l=Math.round(n*o*r);let f=null;for(let i=0;i<o;i+=1)for(let m=0;m<n;m+=1){const p=i*n+m;if(e[p]===0||c[p]===1)continue;let g=0,h=0;d[h]=m,u[h]=i,h+=1,c[p]=1;let k=0,T=m,A=i,C=m,y=i,L=0,E=0;for(;g<h;){const M=d[g],a=u[g];g+=1;const v=a*n+M;k+=1,t[v]===1&&(L+=1),s[v]===1&&(E+=1),M<T&&(T=M),a<A&&(A=a),M>C&&(C=M),a>y&&(y=a);const R=[[M+1,a],[M-1,a],[M,a+1],[M,a-1]];for(const[b,x]of R){if(b<0||x<0||b>=n||x>=o)continue;const I=x*n+b;c[I]===1||e[I]===0||(c[I]=1,d[h]=b,u[h]=x,h+=1)}}if(k<l)continue;const S={minX:T,minY:A,maxX:C,maxY:y,area:k,colorHits:L,edgeHits:E},U=we(S,n*o);(!f||U>f.score)&&(f={component:S,score:U})}return f},Ne=e=>{if(!j)return{found:!1,confidence:0,box:null};const t=e.videoWidth,s=e.videoHeight;if(t<=0||s<=0)return{found:!1,confidence:0,box:null};const n=Math.min(1,he/Math.max(t,s)),o=Math.max(1,Math.round(t*n)),r=Math.max(1,Math.round(s*n));Q.width=o,Q.height=r,j.drawImage(e,0,0,o,r);const c=j.getImageData(0,0,o,r),d=Ie(c.data,o,r);let l=re(d.fusedMask,d.colorMask,d.edgeMask,o,r,oe);if(!l||l.score<ke){const g=re(d.edgeOnlyMask,d.colorMask,d.edgeMask,o,r,oe);g&&(!l||g.score*.9>l.score)&&(l={component:g.component,score:g.score*.9})}if(!l)return{found:!1,confidence:0,box:null};const f=l.component.maxX-l.component.minX+1,i=l.component.maxY-l.component.minY+1,m=V(l.score,0,1),p=1/n;return{found:!0,confidence:m,box:{x:Math.round(l.component.minX*p),y:Math.round(l.component.minY*p),width:Math.round(f*p),height:Math.round(i*p)}}},ie=document.querySelector("#app");if(!ie)throw new Error("Missing #app container");const W=/Chrome/.test(navigator.userAgent)&&!/Edg|OPR/.test(navigator.userAgent),G=!!navigator.mediaDevices?.getUserMedia,N=new ge("Ready"),le=P.retryIntervalMs,Oe={segments:[]};ie.innerHTML=`
  <main class="shell">
    <header>
      <h1>OCR Ticket Reader</h1>
      <p>MVP scaffold initialized for desktop Chrome.</p>
    </header>
    <section class="panel">
      <p><strong>Browser check:</strong> ${W?"Chrome detected":"Please use desktop Chrome for MVP."}</p>
      <p><strong>Camera API:</strong> ${G?"Available":"Not available"}</p>
      <p><strong>Name confidence threshold:</strong> ${P.confidenceThresholdName}</p>
      <p><strong>Seat confidence threshold:</strong> ${P.confidenceThresholdSeat}</p>
      <p><strong>Scan timeout (ms):</strong> ${P.scanTimeoutMs}</p>
      <p><strong>Retry interval (ms):</strong> ${P.retryIntervalMs}</p>
      <p><strong>Frame sample interval (ms):</strong> ${le}</p>
      <p><strong>Audio playback rate:</strong> ${P.audioPlaybackRate}</p>
      <p id="app-state"><strong>App state:</strong> ${N.getState()}</p>
      <p><strong>Latest OCR result:</strong> None</p>
      <p><strong>Queued audio segments:</strong> ${Oe.segments.length}</p>
      <p id="camera-message">Camera preview not started.</p>
      <p id="sample-status"><strong>Sample loop:</strong> idle</p>
      <div class="preview-frame">
        <video id="camera-preview" autoplay muted playsinline></video>
        <div id="ticket-overlay" class="ticket-overlay hidden"></div>
      </div>
      <div class="actions">
        <button id="start-camera-btn" type="button">Enable Camera</button>
        <button id="stop-camera-btn" type="button" disabled>Stop Camera</button>
      </div>
    </section>
  </main>
`;const de=document.querySelector("#app-state"),ue=document.querySelector("#camera-message"),me=document.querySelector("#sample-status"),O=document.querySelector("#camera-preview"),w=document.querySelector("#ticket-overlay"),F=document.querySelector("#start-camera-btn"),K=document.querySelector("#stop-camera-btn");if(!de||!ue||!me||!O||!w||!F||!K)throw new Error("Missing camera preview elements");let q=null,Y=null,D=0;const X=document.createElement("canvas"),ae=X.getContext("2d"),Le=e=>{de.innerHTML=`<strong>App state:</strong> ${e}`},$=e=>{ue.textContent=e},z=e=>{me.innerHTML=`<strong>Sample loop:</strong> ${e}`},J=()=>{w.classList.add("hidden")},Ue=(e,t,s)=>{if(!e.found||!e.box||t<=0||s<=0){J();return}const n=e.box.x/t*100,o=e.box.y/s*100,r=e.box.width/t*100,c=e.box.height/s*100;w.style.left=`${n}%`,w.style.top=`${o}%`,w.style.width=`${r}%`,w.style.height=`${c}%`,w.classList.remove("hidden")};N.subscribe(Le);const ee=()=>{Y!==null&&(window.clearInterval(Y),Y=null),D=0,z("idle")},_e=()=>{if(!ae||!q)return;const e=O.videoWidth,t=O.videoHeight;if(e<=0||t<=0)return;X.width!==e&&(X.width=e),X.height!==t&&(X.height=t),ae.drawImage(O,0,0,e,t);const s=Ne(O);Ue(s,e,t),D+=1,z(s.found?`running (${D} samples, ticket confidence ${s.confidence.toFixed(2)})`:`running (${D} samples, searching ticket)`)},Pe=()=>{ee(),z("starting"),Y=window.setInterval(_e,le)},fe=()=>{if(ee(),J(),!!q){for(const e of q.getTracks())e.stop();q=null,O.srcObject=null,K.disabled=!0,F.disabled=!G||!W,N.setState("Ready"),$("Camera preview stopped.")}},$e=async()=>{if(!G){N.setState("RetryNeeded"),$("Camera API is unavailable in this browser.");return}if(!W){N.setState("RetryNeeded"),$("MVP camera flow is currently supported on desktop Chrome only.");return}try{F.disabled=!0,$("Requesting camera permission..."),q=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:!1}),O.srcObject=q,N.setState("Scanning"),$("Camera preview active."),D=0,Pe(),K.disabled=!1}catch(e){ee(),J(),N.setState("RetryNeeded"),F.disabled=!1,$(e instanceof Error?`Unable to start camera: ${e.message}`:"Unable to start camera.")}};F.disabled=!G||!W;F.addEventListener("click",()=>{$e()});K.addEventListener("click",fe);window.addEventListener("beforeunload",fe);
