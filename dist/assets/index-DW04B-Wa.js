(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const X={confidenceThresholdName:.8,confidenceThresholdSeat:.9,scanTimeoutMs:1500,retryIntervalMs:300,audioPlaybackRate:1},me=e=>Number.isNaN(e)?0:Math.min(1,Math.max(0,e)),q=(e,t)=>t,B={confidenceThresholdName:me(q(void 0,X.confidenceThresholdName)),confidenceThresholdSeat:me(q(void 0,X.confidenceThresholdSeat)),scanTimeoutMs:Math.max(0,q(void 0,X.scanTimeoutMs)),retryIntervalMs:Math.max(0,q(void 0,X.retryIntervalMs)),audioPlaybackRate:Math.max(.1,q(void 0,X.audioPlaybackRate))},Le={Ready:["Scanning","RetryNeeded"],Scanning:["Recognized","RetryNeeded","Ready"],Recognized:["Scanning","Ready"],RetryNeeded:["Scanning","Ready"]};class xe{state;listeners;constructor(t="Ready"){this.state=t,this.listeners=new Set}getState(){return this.state}setState(t){const n=Le[this.state];if(t===this.state||n.includes(t)){this.state=t,this.notify();return}throw new Error(`Invalid scan state transition: ${this.state} -> ${t}`)}subscribe(t){return this.listeners.add(t),t(this.state),()=>{this.listeners.delete(t)}}notify(){for(const t of this.listeners)t(this.state)}}const Re=360,Ne=2.5,fe=.06,we=186,Te=244,Ue=170,Oe=258,Pe=.2,He=.12,pe=.12,Be=.24,Fe=.62,De=0,$e=35,Xe=340,qe=360,Ke=.16,Ve=.78,Ye=.2,Ge=.98,We=.65,je=.35,ge=.75,Qe=.8,Ze=.08,ve=.3,re=document.createElement("canvas"),ae=re.getContext("2d",{willReadFrequently:!0}),K=(e,t,n)=>Math.max(t,Math.min(n,e)),Q=(e,t,n)=>t<=n?e>=t&&e<=n:e>=t||e<=n,ze=(e,t,n)=>{const o=e/255,r=t/255,s=n/255,c=Math.max(o,r,s),p=Math.min(o,r,s),i=c-p;let f=0;i!==0&&(c===o?f=(r-s)/i%6:c===r?f=(s-o)/i+2:f=(o-r)/i+4,f*=60,f<0&&(f+=360));const l=c===0?0:i/c;return{hue:f,saturation:l,value:c}},z=(e,t,n)=>{const o=new Uint8Array(e.length);for(let r=1;r<n-1;r+=1)for(let s=1;s<t-1;s+=1){let c=0;for(let p=-1;p<=1&&c===0;p+=1)for(let i=-1;i<=1;i+=1)if(e[(r+p)*t+(s+i)]===1){c=1;break}o[r*t+s]=c}return o},ye=(e,t,n)=>{const o=new Uint8Array(e.length);for(let r=1;r<n-1;r+=1)for(let s=1;s<t-1;s+=1){let c=1;for(let p=-1;p<=1&&c===1;p+=1)for(let i=-1;i<=1;i+=1)if(e[(r+p)*t+(s+i)]===0){c=0;break}o[r*t+s]=c}return o},Je=(e,t,n)=>z(ye(e,t,n),t,n),be=(e,t,n)=>ye(z(e,t,n),t,n),et=(e,t,n)=>{const o=new Float32Array(t*n);let r=0,s=0,c=0;for(let d=1;d<n-1;d+=1)for(let m=1;m<t-1;m+=1){const b=e[(d-1)*t+(m-1)],g=e[(d-1)*t+m],y=e[(d-1)*t+(m+1)],S=e[d*t+(m-1)],M=e[d*t+(m+1)],A=e[(d+1)*t+(m-1)],C=e[(d+1)*t+m],a=e[(d+1)*t+(m+1)],h=-b+y-S*2+M*2-A+a,v=-b-g*2-y+A+C*2+a,u=Math.abs(h)+Math.abs(v),_=d*t+m;o[_]=u,r+=u,s+=u*u,c+=1}if(c===0)return new Uint8Array(t*n);const p=r/c,i=Math.sqrt(Math.max(0,s/c-p*p)),f=p+i*We,l=new Uint8Array(t*n);for(let d=0;d<l.length;d+=1)l[d]=o[d]>=f?1:0;return l},tt=(e,t,n)=>{const o=t*n,r=new Float32Array(o),s=new Float32Array(o),c=new Float32Array(o),p=new Uint8Array(o);for(let a=0;a<o;a+=1){const h=a*4,v=e[h],u=e[h+1],_=e[h+2],{hue:O,saturation:P,value:H}=ze(v,u,_);r[a]=O,s[a]=P,c[a]=H,p[a]=Math.round(.299*v+.587*u+.114*_)}const i=new Uint8Array(o),f=new Uint8Array(o),l=new Uint8Array(o),d=new Uint8Array(o);for(let a=0;a<o;a+=1){const h=r[a],v=s[a],u=c[a],_=Q(h,we,Te)&&v>=Pe&&u>=pe;i[a]=_?1:0;const O=Q(h,Ue,Oe)&&v>=He&&u>=pe;f[a]=O?1:0;const P=v<=Be&&u>=Fe;l[a]=P?1:0;const H=(Q(h,De,$e)||Q(h,Xe,qe))&&v>=Ke&&v<=Ve&&u>=Ye&&u<=Ge;d[a]=H?1:0}const m=et(p,t,n),b=new Uint8Array(o);for(let a=0;a<o;a+=1)b[a]=i[a]===1||f[a]===1?1:0;const g=z(z(b,t,n),t,n),y=new Uint8Array(o),S=new Uint8Array(o);for(let a=0;a<o;a+=1)y[a]=l[a]===1&&g[a]===1?1:0,S[a]=m[a]===1&&g[a]===1?1:0;const M=new Uint8Array(o);for(let a=0;a<o;a+=1)M[a]=b[a]===1||y[a]===1||S[a]===1?1:0;const A=be(Je(M,t,n),t,n),C=be(m,t,n);return{blueMask:b,labelMask:y,skinMask:d,edgeMask:m,fusedMask:A,edgeOnlyMask:C}},nt=(e,t)=>{const n=e.maxX-e.minX+1,o=e.maxY-e.minY+1,r=n*o;if(r<=0||e.area<=0)return 0;const s=r/t,c=e.area/r,p=n>o?n/o:o/n,i=1-Math.min(1,Math.abs(p-Ne)/1.6),f=e.blueHits/e.area,l=e.labelHits/e.area,d=e.skinHits/e.area,m=e.edgeHits/e.area,b=f>.16?Math.min(1,l/.25):0,g=d>.2?Math.min(.45,(d-.2)*1.3):0,y=f<.12?Math.min(.35,(.12-f)*1.9):0,S=i<.45?(.45-i)*.5:0,M=f>.18&&l>=.04&&l<=.45?.1:0,A=s*1+c*.35+i*1.2+f*1.7+m*.6+b*.5+M-g-y-S;return K(A/5.35,0,1)},Me=(e,t,n,o,r,s,c,p)=>{const i=new Uint8Array(e.length),f=new Int32Array(e.length),l=new Int32Array(e.length),d=Math.round(s*c*p);let m=null;for(let b=0;b<c;b+=1)for(let g=0;g<s;g+=1){const y=b*s+g;if(e[y]===0||i[y]===1)continue;let S=0,M=0;f[M]=g,l[M]=b,M+=1,i[y]=1;let A=0,C=g,a=b,h=g,v=b,u=0,_=0,O=0,P=0;for(;S<M;){const k=f[S],I=l[S];S+=1;const G=I*s+k;A+=1,t[G]===1&&(u+=1),n[G]===1&&(_+=1),o[G]===1&&(O+=1),r[G]===1&&(P+=1),k<C&&(C=k),I<a&&(a=I),k>h&&(h=k),I>v&&(v=I);const Ie=[[k+1,I],[k-1,I],[k,I+1],[k,I-1]];for(const[W,j]of Ie){if(W<0||j<0||W>=s||j>=c)continue;const se=j*s+W;i[se]===1||e[se]===0||(i[se]=1,f[M]=W,l[M]=j,M+=1)}}if(A<d)continue;const H={minX:C,minY:a,maxX:h,maxY:v,area:A,blueHits:u,labelHits:_,skinHits:O,edgeHits:P},ue=nt(H,s*c);(!m||ue>m.score)&&(m={component:H,score:ue})}return m},ot=(e,t={})=>{if(!ae)return{found:!1,confidence:0,box:null};const n=e.videoWidth,o=e.videoHeight;if(n<=0||o<=0)return{found:!1,confidence:0,box:null};const r=Math.min(1,Re/Math.max(n,o)),s=Math.max(1,Math.round(n*r)),c=Math.max(1,Math.round(o*r));re.width=s,re.height=c,ae.drawImage(e,0,0,s,c);const p=ae.getImageData(0,0,s,c),i=tt(p.data,s,c);let l=Me(i.fusedMask,i.blueMask,i.labelMask,i.skinMask,i.edgeMask,s,c,fe),d="hybrid";if(!l||l.score<je){const u=Me(i.edgeOnlyMask,i.blueMask,i.labelMask,i.skinMask,i.edgeMask,s,c,fe);u&&(!l||u.score*ge>l.score)&&(l={component:u.component,score:u.score*ge},d="edge-fallback")}if(!l)return{found:!1,confidence:0,box:null};const m=l.component.maxX-l.component.minX+1,b=l.component.maxY-l.component.minY+1,g=l.component.area,y=g>0?l.component.blueHits/g:0,S=g>0?l.component.labelHits/g:0,M=g>0?l.component.skinHits/g:0,A=g>0?l.component.edgeHits/g:0,C=K(l.score,0,1);let a=C;const h=t?.minBlueSupportRatio??Ze;if(y<h){const u=K(y/Math.max(h,.01),0,1);a=Math.min(a,.55*u)}if(M>ve){const u=K(1-(M-ve)*1.6,.15,1);a*=u}d==="edge-fallback"&&(a*=Qe),a=K(a,0,1);const v=1/r;return{found:!0,confidence:a,box:{x:Math.round(l.component.minX*v),y:Math.round(l.component.minY*v),width:Math.round(m*v),height:Math.round(b*v)},debug:t?.debug?{candidateType:d,blueRatio:y,labelRatio:S,skinRatio:M,edgeRatio:A,rawScore:l.score,confidenceBeforeCaps:C,confidenceAfterCaps:a}:void 0}},Se=document.querySelector("#app");if(!Se)throw new Error("Missing #app container");const w=/Chrome/.test(navigator.userAgent)&&!/Edg|OPR/.test(navigator.userAgent),T=!!navigator.mediaDevices?.getUserMedia,R=new xe("Ready"),Ae=B.retryIntervalMs;let D="environment",U=null;const st={segments:[]};Se.innerHTML=`
  <main class="shell">
    <header>
      <h1>OCR Ticket Reader</h1>
      <p>MVP scaffold initialized for desktop Chrome.</p>
    </header>
    <section class="panel">
      <p><strong>Browser check:</strong> ${w?"Chrome detected":"Please use desktop Chrome for MVP."}</p>
      <p><strong>Camera API:</strong> ${T?"Available":"Not available"}</p>
      <p><strong>Name confidence threshold:</strong> ${B.confidenceThresholdName}</p>
      <p><strong>Seat confidence threshold:</strong> ${B.confidenceThresholdSeat}</p>
      <p><strong>Scan timeout (ms):</strong> ${B.scanTimeoutMs}</p>
      <p><strong>Retry interval (ms):</strong> ${B.retryIntervalMs}</p>
      <p><strong>Frame sample interval (ms):</strong> ${Ae}</p>
      <p><strong>Audio playback rate:</strong> ${B.audioPlaybackRate}</p>
      <p id="app-state"><strong>App state:</strong> ${R.getState()}</p>
      <p><strong>Latest OCR result:</strong> None</p>
      <p><strong>Queued audio segments:</strong> ${st.segments.length}</p>
      <p id="camera-message">Camera preview not started.</p>
      <p id="sample-status"><strong>Sample loop:</strong> idle</p>
      <div class="camera-controls">
        <label for="camera-select"><strong>Camera:</strong></label>
        <select id="camera-select" disabled>
          <option value="">Default rear camera</option>
        </select>
        <button id="switch-facing-btn" type="button" disabled>Switch to Front Camera</button>
      </div>
      <div class="preview-frame">
        <video id="camera-preview" autoplay muted playsinline></video>
        <div id="ticket-overlay" class="ticket-overlay hidden"></div>
      </div>
      <div class="actions">
        <button id="start-camera-btn" type="button">Enable Camera</button>
        <button id="stop-camera-btn" type="button" disabled>Stop Camera</button>
      </div>
    </section>
  </main>
`;const Ee=document.querySelector("#app-state"),Ce=document.querySelector("#camera-message"),_e=document.querySelector("#sample-status"),N=document.querySelector("#camera-preview"),x=document.querySelector("#ticket-overlay"),E=document.querySelector("#camera-select"),ee=document.querySelector("#switch-facing-btn"),$=document.querySelector("#start-camera-btn"),te=document.querySelector("#stop-camera-btn");if(!Ee||!Ce||!_e||!N||!x||!E||!ee||!$||!te)throw new Error("Missing camera preview elements");let L=null,Z=null,Y=0;const V=document.createElement("canvas"),he=V.getContext("2d"),at=e=>{const t=e.toLowerCase();return/(back|rear|environment|world)/.test(t)?"environment":/(front|user|facetime|selfie)/.test(t)?"user":null},ke=()=>{ee.textContent=D==="environment"?"Switch to Front Camera":"Switch to Rear Camera"},J=e=>{E.disabled=!e,ee.disabled=!e,ke()},ne=async()=>{if(!navigator.mediaDevices?.enumerateDevices){E.innerHTML='<option value="">Default camera</option>';return}const t=(await navigator.mediaDevices.enumerateDevices()).filter(o=>o.kind==="videoinput");if(t.length===0){E.innerHTML='<option value="">No camera devices detected</option>';return}E.innerHTML="";const n=document.createElement("option");n.value="",n.textContent=D==="environment"?"Default rear camera":"Default front camera",E.append(n);for(const[o,r]of t.entries()){const s=document.createElement("option");s.value=r.deviceId,s.textContent=r.label||`Camera ${o+1}`,E.append(s)}U?E.value=U:E.value=""},rt=()=>U?{deviceId:{exact:U},width:{ideal:1280},height:{ideal:720}}:{facingMode:{ideal:D},width:{ideal:1280},height:{ideal:720}},ct=e=>{Ee.innerHTML=`<strong>App state:</strong> ${e}`},F=e=>{Ce.textContent=e},ce=e=>{_e.innerHTML=`<strong>Sample loop:</strong> ${e}`},ie=()=>{x.classList.add("hidden")},it=(e,t,n)=>{if(!e.found||!e.box||t<=0||n<=0){ie();return}const o=e.box.x/t*100,r=e.box.y/n*100,s=e.box.width/t*100,c=e.box.height/n*100;x.style.left=`${o}%`,x.style.top=`${r}%`,x.style.width=`${s}%`,x.style.height=`${c}%`,x.classList.remove("hidden")};R.subscribe(ct);const le=()=>{Z!==null&&(window.clearInterval(Z),Z=null),Y=0,ce("idle")},lt=()=>{if(!he||!L)return;const e=N.videoWidth,t=N.videoHeight;if(e<=0||t<=0)return;V.width!==e&&(V.width=e),V.height!==t&&(V.height=t),he.drawImage(N,0,0,e,t);const n=ot(N);it(n,e,t),Y+=1,ce(n.found?`running (${Y} samples, ticket confidence ${n.confidence.toFixed(2)})`:`running (${Y} samples, searching ticket)`)},dt=()=>{le(),ce("starting"),Z=window.setInterval(lt,Ae)},oe=()=>{if(le(),ie(),!!L){for(const e of L.getTracks())e.stop();L=null,N.srcObject=null,te.disabled=!0,$.disabled=!T||!w,J(T&&w),R.setState("Ready"),F("Camera preview stopped.")}},de=async()=>{if(!T){R.setState("RetryNeeded"),F("Camera API is unavailable in this browser.");return}if(!w){R.setState("RetryNeeded"),F("MVP camera flow is currently supported on desktop Chrome only.");return}try{$.disabled=!0,F("Requesting camera permission..."),L=await navigator.mediaDevices.getUserMedia({video:rt(),audio:!1}),N.srcObject=L;const e=L.getVideoTracks()[0],n=e?.getSettings()?.deviceId;if(n&&(U=n),e?.label){const o=at(e.label);o&&(D=o)}await ne(),R.setState("Scanning"),F("Camera preview active."),Y=0,dt(),te.disabled=!1,J(!0)}catch(e){le(),ie(),R.setState("RetryNeeded"),$.disabled=!1,J(T&&w),F(e instanceof Error?`Unable to start camera: ${e.message}`:"Unable to start camera.")}};$.disabled=!T||!w;J(T&&w);ne();$.addEventListener("click",()=>{de()});te.addEventListener("click",oe);E.addEventListener("change",()=>{U=E.value||null,L&&(oe(),de())});ee.addEventListener("click",()=>{D=D==="environment"?"user":"environment",U=null,ne(),L?(oe(),de()):ke()});navigator.mediaDevices?.addEventListener?.("devicechange",()=>{ne()});window.addEventListener("beforeunload",oe);
